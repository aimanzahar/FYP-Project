<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Random Build Generator - HardwareForge</title>
  <link rel="stylesheet" href="public/css/bootstrap.min.css">
  <link rel="stylesheet" href="public/css/randbuildgen.css">
  <link rel="stylesheet" href="public/css/dropdown.css" />
</head>
<body class="dark">
  <div class="wrapper d-flex">
    <aside id="sidebar-container" class="sidebar"></aside>
    <main class="main-content flex-grow-1 p-4">
      <div class="card p-4 shadow mx-auto" style="max-width: 400px;">
        <h3 class="mb-3 text-center">Random PC Build Generator</h3>

        <div class="mb-3">
          <label for="pcType" class="form-label">PC Type</label>
          <select id="pcType" class="form-select" required>
            <option value="">Select PC Type...</option>
            <option value="consumer">Consumer PC (Gaming/Home)</option>
            <option value="workstation">Workstation</option>
            <option value="datacenter">Datacenter Server</option>
          </select>
          <div id="pcTypeInfo" class="form-text text-muted mt-2" style="display: none;">
            <small></small>
          </div>
        </div>

        <div class="mb-3">
          <label for="budget" class="form-label">Budget (RM)</label>
          <input type="number" class="form-control" id="budget" placeholder="Enter your budget">
          <div id="budgetSuggestion" class="form-text text-muted mt-1">
            <small></small>
          </div>
        </div>

        <div class="mb-3">
          <label for="cpuBrand" class="form-label">CPU Brand</label>
          <select id="cpuBrand" class="form-select">
            <option value="any">Any</option>
            <option value="Intel">Intel</option>
            <option value="AMD">AMD</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="gpuBrand" class="form-label">GPU Brand</label>
          <select id="gpuBrand" class="form-select">
            <option value="any">Any</option>
            <option value="NVIDIA">NVIDIA</option>
            <option value="AMD">AMD</option>
          </select>
        </div>

        <button id="generateBtn" class="btn btn-primary w-100">Generate Random Build</button>
        <div id="status" class="mt-3 text-center"></div>
      </div>
    </main>
  </div>

  <div id="dropdown-container"></div>

<script>
const apiBase = 'http://localhost:3001/api';

// Fetch components and optionally filter by brand and PC type
async function fetchComponents(endpoint, brand = 'any', pcType = null) {
    try {
        const res = await fetch(`${apiBase}/${endpoint}`);
        let data = await res.json();

        // Filter by PC type for CPUs (if specified)
        if (pcType && endpoint === 'cpus') {
            data = data.filter(item => item.cpu_category === pcType);
        }

        // Filter by brand
        if (brand !== 'any') {
            const brandLower = brand.toLowerCase().trim();
            data = data.filter(item => item.brand && item.brand.toLowerCase().trim() === brandLower);
        }

        console.log(`Fetched ${endpoint}:`, data);
        return data;
    } catch (err) {
        console.error(`Failed to fetch ${endpoint}:`, err);
        return [];
    }
}

// Get appropriate component suggestions based on PC type
function getPcTypeRecommendations(pcType) {
    const recommendations = {
        consumer: {
            description: "Optimized for gaming, content creation, and home use",
            priorities: ["gaming performance", "good balance", "modern features"],
            typicalBudget: "3000-10000"
        },
        workstation: {
            description: "Built for professional workloads, rendering, and productivity",
            priorities: ["core count", "memory capacity", "stability"],
            typicalBudget: "8000-25000"
        },
        datacenter: {
            description: "Enterprise-grade server for critical workloads",
            priorities: ["reliability", "scalability", "efficiency"],
            typicalBudget: "15000-50000+"
        }
    };
    return recommendations[pcType] || {};
}

function getRandomItem(array) {
    if (!array || array.length === 0) return null;
    return array[Math.floor(Math.random() * array.length)];
}

// Update PC type info when selection changes
document.getElementById('pcType').addEventListener('change', (e) => {
    const pcType = e.target.value;
    const infoDiv = document.getElementById('pcTypeInfo');
    const budgetInput = document.getElementById('budget');
    const budgetSuggestion = document.getElementById('budgetSuggestion');

    if (pcType) {
        const info = getPcTypeRecommendations(pcType);
        infoDiv.querySelector('small').innerHTML = `
            <strong>${info.description}</strong><br>
            Priorities: ${info.priorities.join(', ')}
        `;
        infoDiv.style.display = 'block';

        // Suggest budget range
        budgetSuggestion.querySelector('small').textContent =
            `Typical budget range: RM ${info.typicalBudget}`;
        budgetInput.placeholder = `Suggested: RM ${info.typicalBudget}`;
    } else {
        infoDiv.style.display = 'none';
        budgetSuggestion.querySelector('small').textContent = '';
        budgetInput.placeholder = 'Enter your budget';
    }
});

document.getElementById('generateBtn').addEventListener('click', async () => {
    const status = document.getElementById('status');

    // Validate PC Type selection
    const pcType = document.getElementById('pcType').value;
    if (!pcType) {
        status.textContent = "⚠️ Please select a PC type to continue.";
        status.style.color = "#ffc107";
        return;
    }

    status.textContent = "Generating build...";

    const budget = parseFloat(document.getElementById('budget').value);
    const cpuBrand = document.getElementById('cpuBrand').value;
    const gpuBrand = document.getElementById('gpuBrand').value;

    try {
        const [cpus, gpus, motherboards, rams, cpucoolers, storages, cases, psus] = await Promise.all([
            fetchComponents('cpus', cpuBrand, pcType),
            fetchComponents('gpus', gpuBrand),
            fetchComponents('motherboards'),
            fetchComponents('rams'),
            fetchComponents('cpucoolers'),
            fetchComponents('storages'),
            fetchComponents('cases'),
            fetchComponents('psus')
        ]);

        // Check if PC type filter removed all CPUs
        if (!cpus.length) {
            status.textContent = `❌ No ${pcType} CPUs found. Try selecting "Any" CPU brand or a different PC type.`;
            status.style.color = "#dc3545";
            return;
        }

        // Check if brand filter removed all items
        if ((cpuBrand !== 'any' && !cpus.length) || (gpuBrand !== 'any' && !gpus.length)) {
            status.textContent = `❌ No components found for selected brand(s). Try selecting "Any".`;
            status.style.color = "#dc3545";
            return;
        }

        // Check if any category is empty
        if (!gpus.length || !motherboards.length || !rams.length || !cpucoolers.length || !storages.length || !cases.length || !psus.length) {
            status.textContent = "❌ One or more component categories have no available items. Check your database.";
            status.style.color = "#dc3545";
            return;
        }

        const build = {
            selectedCPU: getRandomItem(cpus),
            selectedGPU: getRandomItem(gpus),
            selectedMotherboard: getRandomItem(motherboards),
            selectedRAM: getRandomItem(rams),
            selectedCpuCooler: getRandomItem(cpucoolers),
            selectedStorage: getRandomItem(storages),
            selectedCase: getRandomItem(cases),
            selectedPSU: getRandomItem(psus)
        };

        const totalPrice = Object.values(build).reduce((sum, item) => sum + (parseFloat(item?.price) || 0), 0);
        if (budget && totalPrice > budget) {
            status.textContent = `⚠️ Generated build exceeds your budget (RM${totalPrice.toFixed(2)}). Try increasing budget or generating again.`;
            status.style.color = "#ffc107";
            return;
        }

        Object.entries(build).forEach(([key, value]) => {
            if (value) localStorage.setItem(key, JSON.stringify(value));
        });

        window.location.href = '/build.html';

    } catch (err) {
        console.error(err);
        status.textContent = "❌ Failed to generate build. Please try again.";
    }
});
</script>

    <script src="public/js/bootstrap.bundle.min.js"></script>
    <script src="public/js/common.js"></script>
</body>
</html>
